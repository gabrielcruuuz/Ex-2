trigger: none
 
pool:
  name: Azure Pipelines
  vmImage: 'windows-latest'
 
variables:
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  solution: '**/*.sln'
  project: '**/ListaContatos.csproj'  
 
stages:
- stage: BuildAndTest
  displayName: 'Build and Test'
  jobs:
  - job: 'BuildTestJob'
    displayName: 'Build, Test and Publish'
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET Core 6'
      inputs:
        version: 6.0.x
        includePreviewVersions: true

    - task: NuGetToolInstaller@1
 
    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: '**/*.csproj'
        feedsToUse: 'select'
 
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)'

    - task: DotNetCoreCLI@2
      displayName: Tests
      inputs:
        command: 'test'
        projects: '**/*.Test.csproj'

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: false
        projects: '**/ListaContatos.csproj'
        arguments: '--configuration release --output $(build.artifactstagingdirectory)'
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        ArtifactName: myproject

- stage: Deploy
  displayName: 'Deployment Stage'
  dependsOn: BuildAndTest
  jobs:
  - job: 'DeployJob'
    displayName: 'Deploy to Azure App Service'
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'myproject'
        downloadPath: '$(Build.ArtifactStagingDirectory)'

    - task: AzureRmWebAppDeployment@4
      inputs:
        ConnectionType: 'AzureRM'
        azureSubscription: 'Pago pelo Uso(c003d420-89ca-42f5-91aa-69ed530214fd)'  # Substitua pelo nome da sua assinatura no Azure
        appType: 'webApp'
        WebAppName: 'ListaContatos-api'  # Substitua pelo nome do seu App Service no Azure
        packageForLinux: '$(Build.ArtifactStagingDirectory)/**/ListaContatos.zip'  # Caminho para o artefato ZIP gerado durante o build